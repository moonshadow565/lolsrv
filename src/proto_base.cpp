#include "proto_base.hpp"

using ProtoVer = ProtoBase;

void ProtoVer::read(Data_in& io, EGP_ID& value) const READ_NOT_IMPL
    void ProtoVer::write(Data_out& io, EGP_ID const& value) const WRITE_NOT_IMPL

    void ProtoVer::read(Data_in& io, PKT_ID& value) const READ_NOT_IMPL
    void ProtoVer::write(Data_out& io, PKT_ID const& value) const WRITE_NOT_IMPL

    void ProtoVer::read(Data_in& io, EGP_RequestJoinTeam& value) const READ_NOT_IMPL
    void ProtoVer::write(Data_out& io, EGP_RequestJoinTeam const& value) const WRITE_NOT_IMPL

    void ProtoVer::read(Data_in& io, EGP_RequestRename& value) const READ_NOT_IMPL
    void ProtoVer::write(Data_out& io, EGP_RequestRename const& value) const WRITE_NOT_IMPL

    void ProtoVer::read(Data_in& io, EGP_RequestReskin& value) const READ_NOT_IMPL
    void ProtoVer::write(Data_out& io, EGP_RequestReskin const& value) const WRITE_NOT_IMPL

    void ProtoVer::read(Data_in& io, EGP_TeamRosterUpdate& value) const READ_NOT_IMPL
    void ProtoVer::write(Data_out& io, EGP_TeamRosterUpdate const& value) const WRITE_NOT_IMPL

    void ProtoVer::read(Data_in& io, EGP_Chat& value) const READ_NOT_IMPL
    void ProtoVer::write(Data_out& io, EGP_Chat const& value) const WRITE_NOT_IMPL

    void ProtoVer::read(Data_in& io, CommonBasicAttack& value) const READ_NOT_IMPL
    void ProtoVer::write(Data_out& io, CommonBasicAttack const& value) const WRITE_NOT_IMPL

    void ProtoVer::read(Data_in& io, ConnectionInfo& value) const READ_NOT_IMPL
    void ProtoVer::write(Data_out& io, ConnectionInfo const& value) const WRITE_NOT_IMPL

    void ProtoVer::read(Data_in& io, PlayerLiteInfo& value) const READ_NOT_IMPL
    void ProtoVer::write(Data_out& io, PlayerLiteInfo const& value) const WRITE_NOT_IMPL

    void ProtoVer::read(Data_in& io, PKT_Basic_Attack& value) const READ_NOT_IMPL
    void ProtoVer::write(Data_out& io, PKT_Basic_Attack const& value) const WRITE_NOT_IMPL

    void ProtoVer::read(Data_in& io, PKT_Basic_Attack_Pos& value) const READ_NOT_IMPL
    void ProtoVer::write(Data_out& io, PKT_Basic_Attack_Pos const& value) const WRITE_NOT_IMPL

    void ProtoVer::read(Data_in& io, PKT_BuyItemAns& value) const READ_NOT_IMPL
    void ProtoVer::write(Data_out& io, PKT_BuyItemAns const& value) const WRITE_NOT_IMPL

    void ProtoVer::read(Data_in& io, PKT_BuyItemReq& value) const READ_NOT_IMPL
    void ProtoVer::write(Data_out& io, PKT_BuyItemReq const& value) const WRITE_NOT_IMPL

    void ProtoVer::read(Data_in& io, PKT_C2S_CharSelected& value) const READ_NOT_IMPL
    void ProtoVer::write(Data_out& io, PKT_C2S_CharSelected const& value) const WRITE_NOT_IMPL

    void ProtoVer::read(Data_in& io, PKT_C2S_ClientReady& value) const READ_NOT_IMPL
    void ProtoVer::write(Data_out& io, PKT_C2S_ClientReady const& value) const WRITE_NOT_IMPL

    void ProtoVer::read(Data_in& io, PKT_C2S_MapPing& value) const READ_NOT_IMPL
    void ProtoVer::write(Data_out& io, PKT_C2S_MapPing const& value) const WRITE_NOT_IMPL

    void ProtoVer::read(Data_in& io, PKT_C2S_Ping_Load_Info& value) const READ_NOT_IMPL
    void ProtoVer::write(Data_out& io, PKT_C2S_Ping_Load_Info const& value) const WRITE_NOT_IMPL

    void ProtoVer::read(Data_in& io, PKT_C2S_PlayEmote& value) const READ_NOT_IMPL
    void ProtoVer::write(Data_out& io, PKT_C2S_PlayEmote const& value) const WRITE_NOT_IMPL

    void ProtoVer::read(Data_in& io, PKT_C2S_QueryStatusReq& value) const READ_NOT_IMPL
    void ProtoVer::write(Data_out& io, PKT_C2S_QueryStatusReq const& value) const WRITE_NOT_IMPL

    void ProtoVer::read(Data_in& io, PKT_C2S_Reconnect& value) const READ_NOT_IMPL
    void ProtoVer::write(Data_out& io, PKT_C2S_Reconnect const& value) const WRITE_NOT_IMPL

    void ProtoVer::read(Data_in& io, PKT_NPC_Die& value) const READ_NOT_IMPL
    void ProtoVer::write(Data_out& io, PKT_NPC_Die const& value) const WRITE_NOT_IMPL

    void ProtoVer::read(Data_in& io, PKT_NPC_LevelUp& value) const READ_NOT_IMPL
    void ProtoVer::write(Data_out& io, PKT_NPC_LevelUp const& value) const WRITE_NOT_IMPL

    void ProtoVer::read(Data_in& io, PKT_NPC_IssueOrderReq& value) const READ_NOT_IMPL
    void ProtoVer::write(Data_out& io, PKT_NPC_IssueOrderReq const& value) const WRITE_NOT_IMPL

    void ProtoVer::read(Data_in& io, PKT_NPC_UpgradeSpellAns& value) const READ_NOT_IMPL
    void ProtoVer::write(Data_out& io, PKT_NPC_UpgradeSpellAns const& value) const WRITE_NOT_IMPL

    void ProtoVer::read(Data_in& io, PKT_NPC_UpgradeSpellReq& value) const READ_NOT_IMPL
    void ProtoVer::write(Data_out& io, PKT_NPC_UpgradeSpellReq const& value) const WRITE_NOT_IMPL

    void ProtoVer::read(Data_in& io, PKT_OnEnterVisiblityClient& value) const READ_NOT_IMPL
    void ProtoVer::write(Data_out& io, PKT_OnEnterVisiblityClient const& value) const WRITE_NOT_IMPL

    void ProtoVer::read(Data_in& io, PKT_RemoveItemAns& value) const READ_NOT_IMPL
    void ProtoVer::write(Data_out& io, PKT_RemoveItemAns const& value) const WRITE_NOT_IMPL

    void ProtoVer::read(Data_in& io, PKT_RemoveItemReq& value) const READ_NOT_IMPL
    void ProtoVer::write(Data_out& io, PKT_RemoveItemReq const& value) const WRITE_NOT_IMPL

    void ProtoVer::read(Data_in& io, PKT_S2C_CreateHero& value) const READ_NOT_IMPL
    void ProtoVer::write(Data_out& io, PKT_S2C_CreateHero const& value) const WRITE_NOT_IMPL

    void ProtoVer::read(Data_in& io, PKT_S2C_ChangeCharacterData& value) const READ_NOT_IMPL
    void ProtoVer::write(Data_out& io, PKT_S2C_ChangeCharacterData const& value) const WRITE_NOT_IMPL

    void ProtoVer::read(Data_in& io, PKT_S2C_CreateTurret& value) const READ_NOT_IMPL
    void ProtoVer::write(Data_out& io, PKT_S2C_CreateTurret const& value) const WRITE_NOT_IMPL

    void ProtoVer::read(Data_in& io, PKT_S2C_FaceDirection& value) const READ_NOT_IMPL
    void ProtoVer::write(Data_out& io, PKT_S2C_FaceDirection const& value) const WRITE_NOT_IMPL

    void ProtoVer::read(Data_in& io, PKT_S2C_EndSpawn& value) const READ_NOT_IMPL
    void ProtoVer::write(Data_out& io, PKT_S2C_EndSpawn const& value) const WRITE_NOT_IMPL

    void ProtoVer::read(Data_in& io, PKT_S2C_MapPing& value) const READ_NOT_IMPL
    void ProtoVer::write(Data_out& io, PKT_S2C_MapPing const& value) const WRITE_NOT_IMPL

    void ProtoVer::read(Data_in& io, PKT_S2C_Ping_Load_Info& value) const READ_NOT_IMPL
    void ProtoVer::write(Data_out& io, PKT_S2C_Ping_Load_Info const& value) const WRITE_NOT_IMPL

    void ProtoVer::read(Data_in& io, PKT_S2C_PlayAnimation& value) const READ_NOT_IMPL
    void ProtoVer::write(Data_out& io, PKT_S2C_PlayAnimation const& value) const WRITE_NOT_IMPL

    void ProtoVer::read(Data_in& io, PKT_S2C_PlayEmote& value) const READ_NOT_IMPL
    void ProtoVer::write(Data_out& io, PKT_S2C_PlayEmote const& value) const WRITE_NOT_IMPL

    void ProtoVer::read(Data_in& io, PKT_S2C_QueryStatusAns& value) const READ_NOT_IMPL
    void ProtoVer::write(Data_out& io, PKT_S2C_QueryStatusAns const& value) const WRITE_NOT_IMPL

    void ProtoVer::read(Data_in& io, PKT_S2C_Reconnect& value) const READ_NOT_IMPL
    void ProtoVer::write(Data_out& io, PKT_S2C_Reconnect const& value) const WRITE_NOT_IMPL

    void ProtoVer::read(Data_in& io, PKT_S2C_StartGame& value) const READ_NOT_IMPL
    void ProtoVer::write(Data_out& io, PKT_S2C_StartGame const& value) const WRITE_NOT_IMPL

    void ProtoVer::read(Data_in& io, PKT_S2C_StartSpawn& value) const READ_NOT_IMPL
    void ProtoVer::write(Data_out& io, PKT_S2C_StartSpawn const& value) const WRITE_NOT_IMPL

    void ProtoVer::read(Data_in& io, PKT_SynchVersionC2S& value) const READ_NOT_IMPL
    void ProtoVer::write(Data_out& io, PKT_SynchVersionC2S const& value) const WRITE_NOT_IMPL

    void ProtoVer::read(Data_in& io, PKT_SynchVersionS2C& value) const READ_NOT_IMPL
    void ProtoVer::write(Data_out& io, PKT_SynchVersionS2C const& value) const WRITE_NOT_IMPL

    void ProtoVer::read(Data_in& io, PKT_SwapItemAns& value) const READ_NOT_IMPL
    void ProtoVer::write(Data_out& io, PKT_SwapItemAns const& value) const WRITE_NOT_IMPL

    void ProtoVer::read(Data_in& io, PKT_SwapItemReq& value) const READ_NOT_IMPL
    void ProtoVer::write(Data_out& io, PKT_SwapItemReq const& value) const WRITE_NOT_IMPL

    void ProtoVer::read(Data_in& io, PKT_S2C_ToggleFoW& value) const READ_NOT_IMPL
    void ProtoVer::write(Data_out& io, PKT_S2C_ToggleFoW const& value) const WRITE_NOT_IMPL

    void ProtoVer::read(Data_in& io, PKT_WaypointList& value) const READ_NOT_IMPL
    void ProtoVer::write(Data_out& io, PKT_WaypointList const& value) const WRITE_NOT_IMPL

    void ProtoVer::read(Data_in& io, PKT_World_LockCamera_Server& value) const READ_NOT_IMPL
    void ProtoVer::write(Data_out& io, PKT_World_LockCamera_Server const& value) const WRITE_NOT_IMPL

    void ProtoVer::read(Data_in& io, PKT_World_SendCamera_Server& value) const READ_NOT_IMPL
    void ProtoVer::write(Data_out& io, PKT_World_SendCamera_Server const& value) const WRITE_NOT_IMPL

    void ProtoVer::read(Data_in& io, PKT_World_SendCamera_Server_Acknologment& value) const READ_NOT_IMPL
    void ProtoVer::write(Data_out& io, PKT_World_SendCamera_Server_Acknologment const& value) const WRITE_NOT_IMPL

    ProtoNameID const& ProtoVer::find_info(std::string_view name, bool is_payload) const {
    Span<ProtoNameID const> const table = is_payload ? egp_array() : pkt_array();
    auto const info = std::find_if(table.begin(), table.end(), [&](auto const& info) { return info.name == name; });
    if (info == table.end()) {
        throw ProtoErrorNoID(name);
    }
    return *info;
}

ProtoNameID const& ProtoVer::find_info(uint16_t id, bool is_payload) const {
    auto const table = is_payload ? egp_array() : pkt_array();
    auto const info = std::find_if(table.begin(), table.end(), [&](auto const& info) { return info.id == id; });
    if (info == table.end()) {
        throw ProtoErrorUnknownID(id);
    }
    return *info;
}

template <typename T, typename... V>
inline bool read_impl_one(ProtoVer const* proto, Data_in& io, std::string_view name, std::variant<V...>& value) {
    if (name == type_name<T>()) {
        proto->read(io, value.template emplace<T>());
        return true;
    } else {
        return false;
    }
}

template <typename... V>
inline bool read_impl(ProtoVer const* proto, Data_in& io, std::string_view name, std::variant<V...>& value) {
    return (read_impl_one<V>(proto, io, name, value) || ...);
}

PKT_C2S ProtoVer::read_pkt(Data_in io, Channel channel) const {
    uint16_t id = {};
    bool is_payload = false;
    PKT_ID pkt_id = {};
    EGP_ID egp_id = {};
    try {
        switch (channel) {
        case CHANNEL_GENERIC_APP_TO_SERVER:
        case CHANNEL_SYNCHCLOCK:
        case CHANNEL_GENERIC_APP_BROADCAST:
        case CHANNEL_GENERIC_APP_BROADCAST_UNRELIABLE:
            read(io, pkt_id);
            id = static_cast<uint16_t>(pkt_id);
            is_payload = false;
            break;
        case CHANNEL_MIDDLE_TIER_ROSTER:
            read(io, egp_id);
            id = static_cast<uint16_t>(egp_id);
            is_payload = true;
            break;
        case CHANNEL_MIDDLE_TIER_CHAT:
            id = find_info("EGP_Chat", true).id;
            egp_id = static_cast<EGP_ID>(id);
            is_payload = true;
            break;
        default:
            throw ProtoErrorBadChannel(channel);
        }
    } catch (IOError const& err) {
        throw ProtoErrorIO("id", err.position);
    }
    auto const& info = find_info(id, is_payload);
    PKT_C2S value = {};
    if (!read_impl(this, io, info.name, value)) {
        throw ProtoErrorReadNotImpl(info.name);
    }
    return value;
}

std::vector<char> ProtoVer::write_pkt(PKT_S2C const& pkt) const {
    return std::visit(
        [this](auto const& pkt) {
            using T = std::remove_cvref_t<decltype(pkt)>;
            constexpr auto name = type_name<T>();
            constexpr auto is_payload = !std::is_base_of_v<DefaultPacket, T>;
            auto const info = find_info(name, is_payload);
            try {
                Data_out io = {};
                if constexpr (is_payload) {
                    write(io, static_cast<EGP_ID>(info.id));
                } else {
                    write(io, static_cast<PKT_ID>(info.id));
                }
                write(io, pkt);
                return io.buffer;
            } catch (IOError const& err) {
                throw ProtoErrorIO(name, err.position);
            }
        },
        pkt);
}
